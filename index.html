<!DOCTYPE html>
<html>

<head>

	<title>Culturas Peruanas Pre-Incaicas</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="data:;base64,=">
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/Turf.js/5.1.5/turf.min.js'></script>
	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css' rel='stylesheet' />
	<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/javascript" src="culture-general.js"></script>
	<script type="text/javascript" src="culture-sites.js"></script>

</head>


<body>

	<!-- MAP, TITLE, DROPDOWN and POPUP HERE -->


	<div id='map'>
		<div id='title'> Culturas Peruanas Pre-Incaicas</div>
		<div id='subtitle'> mapa interactivo</div>
	</div>


	<!-- BOTTOM MODULE v1 WITH CULTURES BOXES INITIAL SCREEN -->

	<div class= 'bottom-module-initial' id='bottomInitial'> 

		<div id='culture0' class='cultures'>
			<div id='line0' class='boxline'>
				<h3 class="box-title" id='cultTitle0'> </h3> 
				<p class="box-dates" id='boxDates0'> </p>
				<img class="box-image" id="boxImage0" src=" ">
			</div>
		</div>

		<div id='culture1' class='cultures'>
			<div id='line1' class='boxline'>
				<h3 class="box-title" id='cultTitle1'> </h3> 
				<p class="box-dates" id='boxDates1'> </p> 
				<img class="box-image" id="boxImage1" src=" ">
			</div>
		</div>

		<div id='culture2' class='cultures'>
			<div id='line2' class='boxline'>
				<h3 class="box-title" id='cultTitle2'> </h3> 
				<p class="box-dates" id='boxDates2'> </p> 
				<img class="box-image" id="boxImage2" src=" ">
			</div>
		</div>


		<div id='culture3' class='cultures'>
			<div id='line3' class='boxline'>
				<h3 class="box-title" id='cultTitle3'> </h3> 
				<p class="box-dates" id='boxDates3'> </p> 
				<img class="box-image" id="boxImage3" src=" ">
			</div>
		</div>

		<div id='culture4' class='cultures'>
			<div id='line4' class='boxline'>
				<h3 class="box-title" id='cultTitle4'> </h3> 
				<p class="box-dates" id='boxDates4'> </p> 
				<img class="box-image" id="boxImage4" src=" ">
			</div>
		</div>

		<div id='culture5' class='cultures'>
			<div id='line5' class='boxline'>
				<h3 class="box-title" id='cultTitle5'> </h3> 
				<p class="box-dates" id='boxDates5'> </p> 
				<img class="box-image" id="boxImage5" src=" ">
			</div>
		</div>

		<div id='culture6' class='cultures'>
			<div id='line6' class='boxline'>
				<h3 class="box-title" id='cultTitle6'> </h3> 
				<p class="box-dates" id='boxDates6'> </p> 
				<img class="box-image" id="boxImage6" src=" ">
			</div>
		</div>

		<div id='culture7' class='cultures'>
			<div id='line7' class='boxline'>
				<h3 class="box-title" id='cultTitle7'> </h3> 
				<p class="box-dates" id='boxDates7'> </p> 
				<img class="box-image" id="boxImage7" src=" ">
			</div>
		</div>

		<div id='culture8' class='cultures'>
			<div id='line8' class='boxline'>
				<h3 class="box-title" id='cultTitle8'> </h3> 
				<p class="box-dates" id='boxDates8'> </p> 
				<img class="box-image" id="boxImage8" src=" ">
			</div>
		</div>

		<div id='culture9' class='cultures'>
			<div id='line9' class='boxline'>
				<h3 class="box-title" id='cultTitle9'> </h3> 
				<p class="box-dates" id='boxDates9'> </p> 
				<img class="box-image" id="boxImage9" src=" ">
			</div>
		</div>

		<div id='culture10' class='cultures'>
			<div id='line10' class='boxline'>
				<h3 class="box-title" id='cultTitle10'> </h3> 
				<p class="box-dates" id='boxDates10'> </p> 
				<img class="box-image" id="boxImage10" src=" ">
			</div>
		</div>

		<div id='culture11' class='cultures'>
			<div id='line11' class='boxline'>
				<h3 class="box-title" id='cultTitle11'> </h3> 
				<p class="box-dates" id='boxDates11'> </p> 
				<img class="box-image" id="boxImage11" src=" ">
			</div>
		</div>

		<div id='culture12' class='cultures'>
			<div id='line12' class='boxline'>
				<h3 class="box-title" id='cultTitle12'> </h3> 
				<p class="box-dates" id='boxDates12'> </p> 
				<img class="box-image" id="boxImage12" src=" ">
			</div>
		</div>

		<div id='culture13' class='cultures'>
			<div id='line13' class='boxline'>
				<h3 class="box-title" id='cultTitle13'> </h3> 
				<p class="box-dates" id='boxDates13'> </p> 
				<img class="box-image" id="boxImage13" src=" ">
			</div>
		</div>

	</div> 

	<!-- BOTTOM MODULE v2 WITH SPECIFIC CULTURE ONCE SELECTED -->

	<div id='bottomCulture' class= 'bottom-module hidden'> 

		<div id="homebutton" class="home-button"> 
			<img class="svgstyle" src="images/arrow.svg" width=7px>
			Volver al Home
		</div>

		<img id="culture-photo" src=" " width=400px>

		<div class="innerbox" id="innerboxculture">

			<h2 id="culture-title" class="module-title"> Cultura Lima </h2>
			<p id="culture-dates" class="curlylegend"> here dates </p>
			<hr>
			<p id="culture-period" class="legend"> Horizonte Tal</p> 
			<p id="culture-capital" class="legend"> Cahuachi</p> 
			<p id="culture-influence" class="legend"> Chavin</p>
			<p id="culture-description" class="module-text"> Aqui toda la descripción correspondiente al sitio arqueológico. </p>
			<p class="boldy legend"> Explora más en:</p>
			<button id="culture-button" class="module-button"><a id="culture-link" class="button-link" href=" " target="_blank">Wikipedia
			</a></button>

		</div>

	</div>

	<div class= 'right-module' id='archeo-sites'> 

		<div id="backtoculture" class="home-button"> 
			<img class="svgstyle" src="images/arrow.svg" width=7px>
			Volver a Cultura
		</div>

		<img id="archeo-photo" src=" " width=400px>

		<div class="innerbox" id="innerboxsite">

			<h4 id="archeo-culture" class="module-mintitle"> Cultura Lima </h4>
			<h2 id="archeo-name" class="module-title"> Cultura Lima </h2>
			<p id="archeo-type" class="curlylegend"> here dates </p>
			<hr>
			<p id="archeo-altname" class="legend"> Horizonte Tal</p> 
			<p id="archeo-address" class="legend"> Cahuachi</p> 
			<p id="archeo-description" class="legend"> Aqui toda la descripción correspondiente al sitio arqueológico. </p> <br>
			<p class="boldy legend"> Explora más en:</p>
			<button id="archeo-button" class="module-button"><a id="archeo-wikilink"  class="button-link" href=" " target="_blank">Wikipedia
			</a></button>
			<button id="archeo-button-trip" class="module-button"><a id="archeo-link-trip" class="button-link" href=" " target="_blank">Tripadvisor
			</a></button>

		</div>
		
	</div>

	<script type="text/javascript">


//MAPBOX ACCESS	AND BASELINE MAP STYLE	
		mapboxgl.accessToken = 'pk.eyJ1IjoiYWxlb3JhMjk2IiwiYSI6ImNrMmttaDlzMDIzeHAzaHE4NnMyamp0eHkifQ.ufBrm_31R6oudOYvQfwgjQ';

		var map = new mapboxgl.Map({
			container: 'map', 
			style: 'mapbox://styles/aleora296/ck9px2uww24951ipb6lrfeoph', 
			center: [-73, -9.50],
			zoom: 3.9
		});


//LOADS THE DATA

		map.on('load', function () {
			for (let i = 0; i < cultureGeneral.features.length; i++) {
				cultureGeneral.features[i]['id'] = i + 1
			}

			for (let i = 0; i < cultureSites.features.length; i++) {
				cultureSites.features[i]['id'] = i + 1
			}

			
//STYLE FOR LAYER			
			culturelayer = map.addLayer({
				id: "culturelayer",
				type: "circle",
				source: {
					type: "geojson",
					data: cultureGeneral,
				},
				minzoom:3,
				maxzoom:4.5,
				paint: {
					'circle-radius': ['to-number', ['get', 'radius']],
					'circle-stroke-color': 'white',
					'circle-stroke-width': 2,
					'circle-color': [
						'case',
						['boolean', ['feature-state', 'hover'], false],
						'#666',
						['get', 'color'],
					],
					'circle-opacity': [
						'case',
						['boolean', ['feature-state', 'hover'], false],
						1,
						0.65
					]
				}
			});

			siteslayer = map.addLayer({
				id: "siteslayer",
				type: "circle",
				source: {
					type: "geojson",
					data: cultureSites,
				},
				minzoom:4.5,
				maxzoom:20,
				paint: {
					'circle-radius': ['to-number', ['get', 'radius']],
					'circle-stroke-color': 'white',
					'circle-stroke-width': 2,
					'circle-color': [
						'case',
						['boolean', ['feature-state', 'hover'], false],
						'#666',
						['get', 'color'],
					],
					'circle-opacity': [
						'case',
						['boolean', ['feature-state', 'hover'], false],
						1,
						0.8
					]
				}
			});
});


//DEFINING COLORS
		var colors = ["#C6658A", "#86511F", "#863589", "#BA95AA", "#B4A178", "#4F428D", "#C9AA31", "#89B22E", "#8F1313", "#205D1B", "#A3A4C7", "#4CC8CC", "#248199", "#D08A40"];

//ADD NAVIGATION BAR
		map.addControl(new mapboxgl.NavigationControl(), 'bottom-left');


// CONTROLS THE POPUP
		var popup = new mapboxgl.Popup({ 
			closeButton: false, 
			closeOnClick: false 
		});


		let hoverCurrentId = null 

		function startHover(e) {
			let feature = e.features[0]

			if (hoverCurrentId) {
				map.setFeatureState({ source: 'culturelayer', id: hoverCurrentId }, { hover: false });
			}
			hoverCurrentId = feature.id
			map.setFeatureState({ source: 'culturelayer', id: hoverCurrentId }, { hover: true });
		}

		function stopHover(e) {
			if (hoverCurrentId) {
				map.setFeatureState({ source: 'culturelayer', id: hoverCurrentId }, { hover: false });
			}
			hoverCurrentId = null;
		}


// DECLARING FUNCTION POPUP 

		function drawPopup(e,n) {
			map.getCanvas().style.cursor = 'pointer';

			var coordinates = e.features[0].geometry.coordinates.slice();
			var placeName = n;

			while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
				coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
			}

/*
			if not inside a mapbox function then 
			cultureGeneral.features[activeCulture].geometry.coordinates[0].lngLat.lng ???
*/

			popup.setLngLat(coordinates)
				.setHTML(placeName)
				.addTo(map);
		}
	

		function removePopup(e) {
			map.getCanvas().style.cursor = '';
			popup.remove();
		}


// CALLING POP UP GENERAL CULTURE
			// draws the popup and changes the hover style When moving the mouse over, 
			map.on('mouseenter', 'culturelayer', function (e) {
				var popName = e.features[0].properties.name;

				startHover(e)
				drawPopup(e,popName)
			});

			// Turns off the hovering and popup when moving the mouse away from a point, 
			map.on('mouseleave', 'culturelayer', function (e) {
				stopHover(e)
 				removePopup(e)
			});

// CALLING POP UP ARCHEO SITES
			// draws the popup and changes the hover style When moving the mouse over, 
			map.on('mouseenter', 'siteslayer', function (e) {
				var popName1 = e.features[0].properties.name;
				var popName2 = e.features[0].properties.site_name;
				var popName = popName1 + ':\n' + popName2

				startHover(e)
				drawPopup(e,popName)
			});

			// Turns off the hovering and popup when moving the mouse away from a point, 
			map.on('mouseleave', 'siteslayer', function (e) {
				stopHover(e)
 				removePopup(e)
			});

// UPDATE BOTTOM MODULE BASED ON CULTURE SELECTED

//THIS WORKS WHEN YOU CLICK A POINT IN THE MAP
		function updateContent(e,feat) {
		    var cultureName = feat.properties.name;
		   	var cultureStart = feat.properties.startDate;
		    var cultureEnd = feat.properties.endDate;
		    var culturePeriod = feat.properties.period;
		    var cultureText = feat.properties.description;
		    var cultureLink = feat.properties.link;
		    var cultureImage = feat.properties.thumbImage;
		    var activeCulture = feat.properties.group_id;
		    var activeColor = colors[activeCulture];

			$('#culture-photo').attr("src", cultureImage);
		    $('#culture-title').html("Cultura " + cultureName).css("color", activeColor);
		    $('#culture-dates').html(cultureStart + " - " + cultureEnd);
		    $('#culture-period').html("<span class='boldy'>Periodo: </span>" + culturePeriod);
		    $('#culture-capital').html("<span class='boldy'>Capital: </span>" + cultureName);
		    $('#culture-influence').html("<span class='boldy'>Influencia: </span>" + cultureName);
		    $('#culture-description').html(cultureText);
		    $('#culture-link').attr("href", cultureLink);
		    $('#culture-link').css("color", activeColor);	
		    $("#culture-button").css("border-color", activeColor);
		    $('#innerboxculture').css("border-left-color", activeColor);	    
		}


//DEFINING FUNCTION THAT WILL UPDATE THE RIGHT SIDE MODULE
		function updateModule(e) {
			let feature = e.features[0]
			var siteName = feature.properties.site_name;
			var siteCulture = feature.properties.name;
			var siteAltName = feature.properties.site_name;
			var siteImage = feature.properties.photo;
			var siteType = feature.properties.type;

			var siteDistrict = feature.properties.district;
			var siteDProvince = feature.properties.province;
			var siteDepartament = feature.properties.department;

			var siteDescrip = feature.properties.type;
			var siteLink = feature.properties.link;
			var activeCulture = feature.properties.group_id;
		    var activeColor = colors[activeCulture];

		    $('#archeo-photo').attr("src", siteImage);
		    $('#archeo-culture').html("Cultura " + siteCulture).css("color", activeColor);
			$('#archeo-name').html(siteName).css("color", activeColor);
			$('#archeo-type').html(siteType);

			$('#archeo-altname').html("<span class='boldy'>Otros Nombres: </span>" + siteName);
			$('#archeo-address').html("<span class='boldy'>Ubicación: </span>" +"Distrito de " + siteDistrict + ", Provincia de " + siteDProvince + ", Departamento de " + siteDepartament);

			$('#archeo-description').html("<span class='boldy'>Descripción: </span>" +siteDescrip);
			$('#archeo-link').attr("href", siteLink).css("color", activeColor);
			$('.module-button').css("border-color", activeColor);
			$('.button-link').css("color", activeColor);
		    $('#innerboxsite').css("border-left-color", activeColor);
	    
		}

		function flyToCultureMap(e) {
			map.flyTo({ center: e.features[0].geometry.coordinates, zoom: 6 });
		}

		function flyToCulture(a) {
			map.flyTo({ center: cultureGeneral.features[a].geometry.coordinates, zoom: 6 });
		}

			// This updates the bottom module on click
			map.on('click', 'culturelayer', function (e) {
				
				$('#bottomCulture').removeClass( "hidden" );
				$('#bottomInitial').addClass( "overlay" );

				let idGroup = e.features[0].properties.group_id;
				let feat = cultureGeneral.features[idGroup];
				updateContent(idGroup,feat)
				removePopup(e)

				for (var i = 0; i < cultureGeneral.features.length; i++){

					let activeCulture = i;
					
					let selectedGroup = feat.properties.name;

						if (!selectedGroup) {
							map.setFilter('siteslayer', null);
						} else {
							map.setFilter('siteslayer', ['==', ['get', 'name'], selectedGroup]);
						}	
				}
				
				flyToCultureMap(e)
			});


			map.on('click', 'siteslayer', function (e) {
				updateModule(e)
				$('#archeo-sites').show(200);
				$('#bottomCulture').removeClass( "hidden" );
	//			$('#bottomInitial').addClass( "hidden" );

				for (var i = 0; i < cultureGeneral.features.length; i++){

					let activeCulture = i;
					let selectedGroup = e.features[0].properties.name;

						if (!selectedGroup) {
							map.setFilter('siteslayer', null);
						} else {
							map.setFilter('siteslayer', ['==', ['get', 'name'], selectedGroup]);
						}	
				}

				flyToCultureMap(e)

				let idGroup = e.features[0].properties.group_id;
				let feat = cultureGeneral.features[idGroup];
				updateContent(idGroup,feat);
				
			});





// EVENT ON CLICK INITIAL CULTURES BOTTOM MODULE
	for (var i = 0; i < cultureGeneral.features.length; i++){

		let activeCulture = i;

			$(document).ready(function () {
	
				//Filters data on map by selected culture
				$('#culture'+activeCulture).on('click',function() {
					var selectedGroup = $('#cultTitle'+activeCulture).text();
						
						if (!selectedGroup) {
							map.setFilter('siteslayer', null);
						} else {
							map.setFilter('siteslayer', ['==', ['get', 'name'], selectedGroup]);
						}

					flyToCulture(activeCulture);

					let featpop = cultureGeneral.features[activeCulture];
					var popName = featpop.properties.name;


					//Remove Initial bottom module and replace by bottom module with specific culture
					$('#bottomCulture').removeClass( "hidden" );
		//			$('#bottomInitial').addClass( "hidden" );

					// Loads data for bottom module depending on selected culture
			  		let feat = cultureGeneral.features[activeCulture];
					updateContent(activeCulture,feat);

				});

			});

	}


/*

*/

//CHANGES THE DATA OF INITIAL AND CULTURE SCREENS

		for (var i = 0; i < cultureGeneral.features.length; i++){

			  var activeCulture = i;
			  var activeColor = colors[activeCulture];
		      var cultName = cultureGeneral.features[i].properties.name; // initial screen
		      var cultureStart = cultureGeneral.features[i].properties.startDate;
		      var cultureEnd = cultureGeneral.features[i].properties.endDate;
		      var cultureImage = cultureGeneral.features[i].properties.thumbImage;

					$('#cultTitle'+ activeCulture).html(cultName);
					$("#cultTitle"+ activeCulture).css("color", activeColor);
					$('#boxDates'+ activeCulture).html(cultureStart + " - " + cultureEnd);
					$('#boxImage'+ activeCulture).attr("src", cultureImage);
					$('#line'+ activeCulture).css("border-left-color", activeColor);
}


//JQUERY FOR RIGHT MODULE

		$(document).ready(function () {

			$('#archeo-sites').css({
				display:'none'
			});

			$('#closeButton').on('click',function() {
				$('#archeo-sites').hide(200);
			});

		});



// TITLE ELEMENT & BACK BUTTON AS HOME BUTTON


	$(document).ready(function () {
		$('#homebutton, #title').on('click',function() {

			
			map.setFilter('siteslayer', null);


			map.fitBounds([
			[-86.096764, -20.009484],
			[-60.937729, 1.540818]
			]); 

			$('#bottomCulture').addClass( "hidden" );
			$('#bottomInitial').removeClass( "hidden" );
			$('#archeo-sites').hide(200);
		});
	});

// BACK BUTTON TO CULTURE

	$(document).ready(function () {
		$('#backtoculture, #archeo-culture').on('click',function() {
			$('#archeo-sites').hide(200);
		});
	});


	</script>


</body>

</html>